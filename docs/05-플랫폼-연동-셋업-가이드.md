# 플랫폼 데이터 연동 — 셋업 가이드

> 이 문서는 외부 광고/분석 플랫폼 연동을 실제로 동작시키기 위해 **개발자(또는 관리자)가 직접 준비해야 할 항목**을 정리합니다.

---

## 1. 환경 변수 설정 (`.env.local`)

아래 변수를 `.env.local`에 추가해야 합니다.  
이미 존재하는 변수는 건드리지 않습니다.

```bash
# ── 기존 (이미 설정되어 있을 것) ──
NEXT_PUBLIC_SUPABASE_URL=https://xxxxx.supabase.co
NEXT_PUBLIC_SUPABASE_ANON_KEY=eyJhbGciOi...
SUPABASE_SERVICE_ROLE_KEY=eyJhbGciOi...

# ── 새로 추가 ──

# 앱 URL (로컬 개발 시, 배포 시 실제 도메인으로 변경)
NEXT_PUBLIC_APP_URL=http://localhost:3000

# Vercel Cron 보안 토큰 (아무 랜덤 문자열)
# Vercel 대시보드 > Settings > Environment Variables에도 동일하게 설정
CRON_SECRET=my-super-secret-cron-token-12345

# ── Meta Ads (Facebook/Instagram) ──
META_APP_ID=               # Facebook Developer App ID
META_APP_SECRET=           # Facebook Developer App Secret

# ── Google Ads + GA4 ──
GOOGLE_CLIENT_ID=          # Google Cloud Console OAuth 2.0 Client ID
GOOGLE_CLIENT_SECRET=      # Google Cloud Console OAuth 2.0 Client Secret

# ── Google Gemini AI (보고서 자동 생성) ──
GEMINI_API_KEY=            # Google AI Studio에서 발급
```

---

## 2. Supabase SQL 마이그레이션

아직 실행하지 않았다면 아래 파일의 SQL을 Supabase SQL Editor에서 실행합니다:

📄 **파일 경로:** `supabase/sql/04-migrations/001-add-contact-fields.sql`

이 SQL에 이미 포함된 항목:
- `data_integrations` 테이블 (연동 정보 저장)
- `integration_sync_logs` 테이블 (동기화 로그)
- `platform_metrics` 테이블 (수집된 지표)
- 각 테이블에 대한 RLS 정책
- 인덱스
- `updated_at` 트리거

> ⚠️ 이미 실행한 적 있다면 `DROP POLICY IF EXISTS`가 포함되어 있으므로 재실행해도 안전합니다.

실행 후, 반드시 **PostgREST 스키마 캐시를 리로드**하세요:
```sql
NOTIFY pgrst, 'reload schema';
```

---

## 3. 플랫폼별 사전 준비

### 3-1. 네이버 검색광고 (가장 간단, OAuth 불필요)

| 항목 | 설명 |
|------|------|
| **발급 위치** | [네이버 검색광고 API 관리](https://manage.searchad.naver.com) |
| **필요한 키** | API Key, Secret Key, Customer ID |
| **발급 방법** | 네이버 검색광고 로그인 → 도구 → API 관리 → 라이선스 발급 |
| **비용** | 무료 |
| **입력 위치** | 관리자 → 클라이언트 상세 → 데이터 연동 탭 → 연동 추가 → 네이버 검색광고 선택 |

**테스트 방법:**
1. API Key, Secret Key, Customer ID 입력
2. "연결 테스트" 버튼 클릭
3. "✅ 연결 성공" 확인
4. "연동 저장" 클릭
5. 목록에서 🔄 아이콘(수동 동기화) 클릭하여 데이터 수집 확인

---

### 3-2. Meta Ads (Facebook/Instagram)

| 항목 | 설명 |
|------|------|
| **발급 위치** | [Meta for Developers](https://developers.facebook.com) |
| **필요한 것** | Facebook App 생성, Business Verification |
| **필요한 퍼미션** | `ads_read`, `ads_management` |
| **토큰 유형** | Long-lived Token (60일, 자동 갱신 로직 포함) |

**준비 단계:**

1. **Facebook App 만들기**
   - https://developers.facebook.com → "My Apps" → "Create App"
   - 앱 타입: "Business"
   - 앱 이름 지정 후 생성

2. **Facebook Login 추가**
   - 앱 대시보드 → Products → "Facebook Login" 추가
   - Settings → Valid OAuth Redirect URIs에 추가:
     ```
     http://localhost:3000/api/auth/meta/callback
     https://your-domain.com/api/auth/meta/callback
     ```

3. **Marketing API 활성화**
   - Products → "Marketing API" 추가

4. **환경 변수 설정**
   - App ID → `META_APP_ID`
   - App Secret → `META_APP_SECRET`

5. **연동 방법 (관리자 페이지에서)**
   - 클라이언트 상세 → 데이터 연동 탭
   - "Meta OAuth" 버튼 클릭 → Facebook 로그인 동의
   - 또는 직접 Access Token, Ad Account ID 입력

> ⚠️ 앱이 "개발 모드"에서는 본인 계정만 테스트 가능합니다.
> 타인의 광고 계정을 연동하려면 "라이브 모드"로 전환 + Business Verification이 필요합니다.

---

### 3-3. Google Ads

| 항목 | 설명 |
|------|------|
| **발급 위치** | [Google Cloud Console](https://console.cloud.google.com) |
| **필요한 것** | OAuth 2.0 Client, Google Ads Developer Token |
| **토큰 유형** | Refresh Token (만료 없음) |

**준비 단계:**

1. **Google Cloud 프로젝트 생성**
   - https://console.cloud.google.com → 새 프로젝트 생성

2. **OAuth Consent Screen 설정**
   - APIs & Services → OAuth consent screen
   - User Type: External (테스트는 Internal로도 가능)
   - 앱 이름, 이메일 등 입력
   - Scopes 추가: `https://www.googleapis.com/auth/adwords.readonly`

3. **OAuth 2.0 Client ID 생성**
   - APIs & Services → Credentials → Create Credentials → OAuth client ID
   - Application type: Web application
   - Authorized redirect URIs에 추가:
     ```
     http://localhost:3000/api/auth/google/callback
     https://your-domain.com/api/auth/google/callback
     ```
   - Client ID → `GOOGLE_CLIENT_ID`
   - Client Secret → `GOOGLE_CLIENT_SECRET`

4. **Google Ads API 활성화**
   - APIs & Services → Library → "Google Ads API" 검색 → Enable

5. **Developer Token 발급**
   - https://ads.google.com → 도구 및 설정 → 설정 → API 센터
   - Developer Token 발급 (초기에는 Test Account만 사용 가능)

6. **연동 방법**
   - 관리자 → 클라이언트 상세 → 데이터 연동 → "Google OAuth" 버튼 클릭
   - Google 로그인 동의 후, Refresh Token + Customer ID + Developer Token 입력

> ⚠️ Developer Token은 신청 후 승인까지 며칠 소요될 수 있습니다.
> 테스트 계정으로 먼저 테스트하세요.

---

### 3-4. Google Analytics (GA4)

| 항목 | 설명 |
|------|------|
| **발급 위치** | [Google Cloud Console](https://console.cloud.google.com) (Google Ads와 동일 프로젝트 사용 가능) |
| **추가 Scope** | `https://www.googleapis.com/auth/analytics.readonly` |

**준비 단계:**

1. Google Cloud 프로젝트에서 아래 API 활성화:
   - **Google Analytics Data API** (v1beta)
   - **Google Analytics Admin API** (v1beta)

2. OAuth Consent Screen의 Scope에 추가:
   ```
   https://www.googleapis.com/auth/analytics.readonly
   ```

3. **연동 방법**
   - "Google OAuth" 버튼으로 동일하게 인증 (Ads + GA4 scope 모두 포함)
   - GA4 Property ID 입력 (형식: `properties/123456789`)
   - Property ID 확인: GA4 관리 → 속성 → 속성 설정 → 속성 ID

> 💡 Google Ads와 GA4는 같은 OAuth 인증을 공유할 수 있습니다.
> 하나의 Google OAuth로 두 서비스 모두 연결 가능합니다.

---

### 3-5. Google Gemini AI (보고서 자동 생성)

| 항목 | 설명 |
|------|------|
| **발급 위치** | [Google AI Studio](https://aistudio.google.com/apikey) |
| **비용** | 무료 tier 제공 (분당 15 요청) |

**준비 단계:**

1. https://aistudio.google.com/apikey 에서 API Key 생성
2. `.env.local`에 `GEMINI_API_KEY=your-key` 추가

---

## 4. Vercel 배포 설정

### 4-1. Cron Jobs

`vercel.json`에 이미 설정되어 있습니다:

| Cron | 시간 (UTC) | 한국시간 | 역할 |
|------|-----------|---------|------|
| `/api/cron/sync-metrics` | 매일 21:00 | 매일 06:00 | 모든 연동 데이터 동기화 |
| `/api/cron/generate-report` | 매주 월요일 00:00 | 매주 월요일 09:00 | AI 주간 보고서 자동 생성 |

### 4-2. Vercel 환경 변수

Vercel 대시보드 → Settings → Environment Variables에 위 `.env.local`과 동일한 변수를 모두 추가합니다.

> ⚠️ `CRON_SECRET`은 반드시 Vercel에 설정해야 cron이 인증됩니다.

### 4-3. Vercel Pro 플랜 (선택)

- Free 플랜: Cron 1일 1회만 가능
- Pro 플랜: Cron 시간당 실행 가능, maxDuration 300초

---

## 5. 동작 확인 체크리스트

### Phase 1: 인프라
- [ ] SQL 마이그레이션 실행 완료
- [ ] `NOTIFY pgrst, 'reload schema';` 실행
- [ ] `.env.local`에 `NEXT_PUBLIC_APP_URL`, `CRON_SECRET` 추가

### Phase 2: 네이버 검색광고
- [ ] 네이버 검색광고 API 라이선스 발급
- [ ] 관리자 → 클라이언트 → 데이터 연동 → 네이버 연동 추가
- [ ] 연결 테스트 성공
- [ ] 수동 동기화 실행 → 데이터 수집 확인

### Phase 3: Meta Ads
- [ ] Facebook App 생성 및 `.env.local`에 키 추가
- [ ] OAuth redirect URI 설정
- [ ] 관리자에서 Meta OAuth 인증 완료
- [ ] Ad Account 선택 후 연동 저장
- [ ] 수동 동기화 실행

### Phase 4: Google Ads + GA4
- [ ] Google Cloud 프로젝트 및 OAuth Client 생성
- [ ] `.env.local`에 키 추가
- [ ] Google Ads API + Analytics API 활성화
- [ ] Google Ads Developer Token 발급
- [ ] 관리자에서 Google OAuth 인증 완료
- [ ] Ads CID, GA4 Property ID 입력 후 연동 저장
- [ ] 수동 동기화 실행

### Phase 5: AI 보고서
- [ ] Gemini API Key 발급 및 `.env.local`에 추가
- [ ] 위 플랫폼 연동 중 하나라도 데이터 수집 성공
- [ ] `/api/cron/generate-report`에 대한 cURL 테스트:
  ```bash
  curl -H "Authorization: Bearer my-super-secret-cron-token-12345" \
       http://localhost:3000/api/cron/generate-report
  ```
- [ ] 클라이언트 리포트 페이지에 AI 생성 보고서 확인

---

## 6. 문제 해결 (Troubleshooting)

| 증상 | 원인 | 해결 |
|------|------|------|
| "연결 실패" (네이버) | API Key/Secret 오타 | 키 재확인, HMAC 서명은 자동 생성됨 |
| "연결 실패" (Meta) | 토큰 만료 또는 퍼미션 부족 | Meta OAuth 재인증 |
| "연결 실패" (Google) | OAuth Consent Screen 미설정 | 위 3-3 단계 확인 |
| Cron 실행 안됨 | `CRON_SECRET` 불일치 | Vercel 환경변수 확인 |
| "enabled_services" 관련 에러 | PostgREST 스키마 캐시 | `NOTIFY pgrst, 'reload schema';` |
| AI 보고서 생성 안됨 | `GEMINI_API_KEY` 미설정 | 환경변수 확인 |

---

## 7. 파일 구조 참조

```
src/
  lib/
    integrations/
      sync-engine.ts   → 공통 동기화 엔진
      naver.ts         → 네이버 검색광고 API
      meta.ts          → Meta Ads API
      google-ads.ts    → Google Ads API
      ga4.ts           → GA4 Data API
    ai/
      report-generator.ts → Gemini AI 보고서 생성
  app/
    api/
      admin/integrations/      → 연동 CRUD + 테스트 + 수동동기화
      auth/meta/callback/      → Meta OAuth 콜백
      auth/google/callback/    → Google OAuth 콜백
      cron/sync-metrics/       → 데이터 동기화 Cron
      cron/generate-report/    → AI 보고서 생성 Cron
    (portal)/marketing/        → 클라이언트 마케팅 성과 대시보드
vercel.json                    → Cron 스케줄 설정
```
