# 12. 할 일 숙제 통합 (원마케팅)

> SQL 007·008·**009**는 **실행 완료**했다고 가정합니다.  
> 아래는 **카카오 알림톡(월/수/목 루틴)** 및 기타 미완료 설정을 한 곳에 정리한 체크리스트입니다.  
> 관련 내용이 분산돼 있던 `01-먼저-할-일.md`, `05-플랫폼-연동-셋업-가이드.md`, 알림톡 코드를 통합했습니다.

---

## 1. 이미 한 것 (확인용)

- [x] **Migration 007** — `notifications` 테이블 생성 (Supabase SQL Editor에서 실행 완료)
- [x] **Migration 008** — 클라이언트 알림 조회 RLS 정책 추가 (실행 완료)
- [x] **Migration 009** — `addon_orders` 테이블 생성 (부가 서비스 주문, 실행 완료)

---

## 2. 환경 변수 (`.env.local`)

프로젝트 루트 `.env.local`에 아래가 **모두** 있는지 확인하세요. 없으면 추가합니다.

| 변수명 | 용도 | 비고 |
|--------|------|------|
| `NEXT_PUBLIC_SUPABASE_URL` | Supabase 프로젝트 URL | 이미 있음 |
| `NEXT_PUBLIC_SUPABASE_ANON_KEY` | Supabase Anon Key | 이미 있음 |
| `SUPABASE_SERVICE_ROLE_KEY` | Supabase Service Role Key | 이미 있음 |
| `NEXT_PUBLIC_APP_URL` | 앱 주소 (매직링크·알림톡 링크에 사용) | 로컬: `http://localhost:3000` / **배포 시 실제 도메인** (예: `https://www.onemarketing.kr`) |
| `CRON_SECRET` | Cron API 호출 시 인증 | 로컬·Vercel **동일한 값**으로 설정 |
| `GEMINI_API_KEY` | AI 요약 문구 생성 (월/수/목 알림) | 이미 있음 |
| **`SOLAPI_API_KEY`** | 솔라피 API Key | **알림톡용 — 추가 필요** |
| **`SOLAPI_API_SECRET`** | 솔라피 API Secret | **알림톡용 — 추가 필요** |
| **`SOLAPI_PFID`** | 카카오톡 채널 프로필 ID | **알림톡용 — 추가 필요** |
| `SOLAPI_SENDER_NUMBER` | 발신번호 (SMS 대체용, 선택) | 없어도 동작하나 비상 시 권장 |
| **`ADMIN_NOTIFY_PHONE`** | 부가 서비스 주문 접수 시 관리자 알림톡 수신 번호 | **부가 서비스 스토어용** (섹션 9 참고) |

**추가할 예시 (알림톡용):**

```env
SOLAPI_API_KEY=발급받은_API_Key
SOLAPI_API_SECRET=발급받은_Secret
SOLAPI_PFID=카카오채널_프로필ID
SOLAPI_SENDER_NUMBER=01012345678
```

- [ ] 위 4개(또는 3개) 환경 변수 `.env.local`에 추가
- [ ] **배포 시** Vercel → Settings → Environment Variables 에 `NEXT_PUBLIC_APP_URL`, `CRON_SECRET`, `SOLAPI_*` 동일하게 설정

---

## 3. 솔라피(Solapi) 가입 및 API 발급

| 항목 | 내용 |
|------|------|
| **사이트** | https://solapi.com |
| **비용** | 알림톡 1건당 약 8원 (선불 충전) |

**순서:**

1. solapi.com 회원가입
2. 콘솔 → **API Key 관리** → API Key & Secret 발급
3. 발급한 값으로 `.env.local`에 `SOLAPI_API_KEY`, `SOLAPI_API_SECRET` 설정

- [ ] 솔라피 가입 및 API Key·Secret 발급
- [ ] `.env.local`에 위 두 값 입력

---

## 4. 카카오톡 비즈니스 채널 설정

1. [카카오비즈니스](https://business.kakao.com) 가입
2. **카카오톡 채널** 생성 (예: @onecation)
3. **솔라피 콘솔**에서 카카오톡 채널 연동
4. 연동 후 **프로필 ID(PFID)** 확인 → `.env.local`에 `SOLAPI_PFID=해당값` 설정
5. (선택) 발신번호 등록 → `SOLAPI_SENDER_NUMBER` 설정

- [ ] 카카오 비즈니스 채널 생성
- [ ] 솔라피와 채널 연동 후 PFID 확인
- [ ] `.env.local`에 `SOLAPI_PFID` 입력

---

## 5. 카카오 알림톡 템플릿 등록 (필수)

카카오 비즈센터에서 아래 **모든 템플릿**을 사전 등록·승인받아야 합니다.  
승인까지 **1~2영업일** 걸릴 수 있습니다.

**코드에서 쓰는 템플릿 ID**는 `src/lib/notifications/alimtalk.ts`의 `TEMPLATE_IDS`와 **완전히 동일**하게 등록해야 합니다.  
(다른 ID로 등록했다면 alimtalk.ts 안의 상수 값을 수정하세요.)

### 5-1. 기존 템플릿 (관리자 수동 발송용)

| 템플릿 ID | 용도 | 치환 변수 |
|-----------|------|-----------|
| `TPL_report_published` | 보고서 발행 알림 | `#{고객명}`, `#{리포트제목}`, `#{링크}` |
| `TPL_action_status` | 실행항목 상태 변경 | `#{고객명}`, `#{작업명}`, `#{이전상태}`, `#{현재상태}` |
| `TPL_event_reminder` | 일정 리마인더 | `#{고객명}`, `#{일정명}`, `#{날짜}` |
| `TPL_password_reset` | 비밀번호 리셋 안내 | (코드 참고) |

### 5-2. 월/수/목 주간 알림용 (신규)

| 템플릿 ID | 발송 요일 | 용도 | 치환 변수 |
|-----------|-----------|------|-----------|
| **`TPL_mon_review`** | 월요일 | 지난주 성과 리뷰 | `#{고객명}`, `#{요약}`, `#{자세히보기}` |
| **`TPL_wed_budget`** | 수요일 | 예산 페이싱 | `#{고객명}`, `#{요약}`, `#{자세히보기}` |
| **`TPL_thu_proposal`** | 목요일 | 다음 주 제안 + 승인 | `#{고객명}`, `#{요약}`, `#{자세히보기}`, `#{승인하기}` |

### 5-3. 부가 서비스 주문 (관리자 수신)

| 템플릿 ID | 용도 | 치환 변수 |
|-----------|------|-----------|
| **`TPL_addon_order_admin`** | 부가 서비스 주문 접수 시 관리자에게 알림 | `#{고객명}`, `#{서비스명}`, `#{금액}`, `#{링크}` |

- **`#{링크}`**에는 관리자 주문 목록 URL이 들어갑니다. (자세한 설정은 섹션 9 참고)

- **`#{자세히보기}`** · **`#{승인하기}`** 에는 **URL**이 들어갑니다. (알림톡에서 버튼/링크로 사용) · **`#{승인하기}`** 에는 **URL**이 들어갑니다. (알림톡에서 버튼/링크로 사용)
- 카카오 템플릿 등록 시 “버튼/링크” 형식에 맞춰 등록해야 합니다.

**체크:**

- [ ] `TPL_report_published` 등록·승인
- [ ] `TPL_action_status` 등록·승인
- [ ] `TPL_event_reminder` 등록·승인
- [ ] `TPL_password_reset` 등록·승인 (사용 시)
- [ ] **`TPL_mon_review`** 등록·승인 (변수: 고객명, 요약, 자세히보기)
- [ ] **`TPL_wed_budget`** 등록·승인 (변수: 고객명, 요약, 자세히보기)
- [ ] **`TPL_thu_proposal`** 등록·승인 (변수: 고객명, 요약, 자세히보기, 승인하기)
- [ ] **`TPL_addon_order_admin`** 등록·승인 (부가 서비스 주문 접수 → 관리자 수신, 변수: 고객명, 서비스명, 금액, 링크)

---

## 6. Vercel 배포 시 할 일

월/수/목 **Cron**이 배포 환경에서 돌아가려면:

1. **Vercel** → 해당 프로젝트 → **Settings** → **Environment Variables**
2. 아래 변수 추가(또는 수정):
   - `CRON_SECRET` — 로컬과 **같은 값** (Cron 호출 시 `Authorization: Bearer <CRON_SECRET>` 검증)
   - `NEXT_PUBLIC_APP_URL` — **실제 서비스 URL** (예: `https://www.onemarketing.kr`)  
     → 알림톡 “자세히 보기”·“승인하기” 링크가 이 주소로 붙음
   - `SOLAPI_API_KEY`, `SOLAPI_API_SECRET`, `SOLAPI_PFID` (및 필요 시 `SOLAPI_SENDER_NUMBER`)
   - `GEMINI_API_KEY` (이미 있으면 유지)
   - Supabase 관련 3종 (이미 있으면 유지)

3. **Cron 스케줄**은 `vercel.json`에 이미 들어가 있음:
   - 월 00:30 UTC (= 한국 09:30)
   - 수 05:00 UTC (= 한국 14:00)
   - 목 07:00 UTC (= 한국 16:00)

- [ ] Vercel 환경 변수에 `CRON_SECRET`, `NEXT_PUBLIC_APP_URL`(실서비스 URL), `SOLAPI_*` 설정
- [ ] 배포 후 Cron이 호출되는지 로그로 한 번 확인 (선택)

---

## 7. 테스트 방법

### 7-1. 알림톡 수동 테스트 (관리자)

1. 관리자 로그인 → **알림 설정** 페이지 이동
2. 전화번호가 등록된 클라이언트 선택
3. 알림 유형(보고서 발행 등) 선택 후 **테스트 발송**
4. 실제 수신 여부 확인

### 7-2. 월/수/목 자동 발송 테스트

- **로컬**: Cron을 직접 호출해 테스트  
  ```bash
  curl -H "Authorization: Bearer onecation2024" "http://localhost:3000/api/cron/send-weekly-alimtalk"
  ```  
  (오늘이 월/수/목이 아니면 “오늘은 발송 요일이 아닙니다” 메시지가 나옴)
- **배포**: Vercel Cron 실행일(월/수/목)에 자동 호출되므로, 그날 로그에서 `send-weekly-alimtalk` 응답 확인

### 7-3. 매직링크(토큰) 동작 확인

1. 테스트용으로 `notifications` 테이블에 한 건 insert (또는 위 Cron 테스트로 생성)
2. 해당 행의 `view_token`으로 브라우저에서 `http://localhost:3000/report/v/<view_token>` 접속
3. 상세 페이지 + “전체 대시보드 보기” 링크 동작 확인
4. 목요일 건이면 `approval_token`으로 `/report/approve/<approval_token>` 접속 후 승인 버튼 동작 확인

- [ ] 알림 설정 페이지에서 테스트 발송 1회 성공
- [ ] (선택) Cron 수동 호출로 월/수/목 알림 1회 성공
- [ ] (선택) 토큰 URL로 상세·승인 페이지 접속 확인

---

## 8. 기타 참고 (다른 문서)

- **첫 설정 전체**: `01-먼저-할-일.md`  
  (Node, npm install, Supabase schema 01~03, Auth 사용자, 프로필 등)
- **플랫폼 연동( Meta, Google, 네이버 등)**: `05-플랫폼-연동-셋업-가이드.md`
- **Google OAuth 발급**: `09-Google-OAuth-클라이언트-발급-가이드.md`
- **Meta OAuth**: `10-Meta-OAuth-이어하기.md`

위 문서들에서 아직 안 한 항목이 있으면 해당 문서 체크리스트도 순서대로 진행하면 됩니다.

---

## 9. 부가 서비스 스토어 (Add-on Store) 숙제

클라이언트가 부가 서비스를 신청하면 DB에 저장되고, **관리자에게 알림톡**이 가도록 하려면 아래를 진행하세요.

### 9-1. Migration 009 실행

- **파일**: `supabase/sql/04-migrations/009-addon-orders.sql`
- **내용**: `addon_orders` 테이블 생성 (부가 서비스 주문 저장)
- Supabase 대시보드 → **SQL Editor**에서 해당 파일 내용 복사·실행

- [x] **Migration 009** 실행 완료

### 9-2. 관리자 알림 수신 번호 설정

부가 서비스 주문이 접수되면 **관리자(또는 팀)** 휴대폰으로 알림톡이 발송됩니다.

| 변수명 | 용도 |
|--------|------|
| **`ADMIN_NOTIFY_PHONE`** | 부가 서비스 주문 접수 시 알림톡 수신 번호 (예: `01012345678`) |

- `.env.local`에 추가:
  ```env
  ADMIN_NOTIFY_PHONE=01012345678
  ```
- 배포 시 Vercel 환경 변수에도 동일하게 추가

- [ ] `.env.local`에 `ADMIN_NOTIFY_PHONE` 추가
- [ ] (배포 시) Vercel 환경 변수에 `ADMIN_NOTIFY_PHONE` 추가

### 9-3. 부가 서비스 주문 알림 템플릿 (카카오)

관리자에게 보낼 **부가 서비스 주문 접수** 알림톡 템플릿을 카카오 비즈센터에 등록·승인받아야 합니다.

| 템플릿 ID | 용도 | 치환 변수 |
|-----------|------|-----------|
| **`TPL_addon_order_admin`** | 부가 서비스 주문 접수 (관리자 수신) | `#{고객명}`, `#{서비스명}`, `#{금액}`, `#{링크}` |

- **`#{링크}`**에는 관리자 주문 목록 URL(`/admin/addon-orders`)이 들어갑니다. (버튼/링크 형식으로 등록)
- 코드 상수: `src/lib/notifications/alimtalk.ts` → `TEMPLATE_IDS.ADDON_ORDER_TO_ADMIN`

- [ ] 카카오에 **`TPL_addon_order_admin`** 템플릿 등록·승인 (변수: 고객명, 서비스명, 금액, 링크)

### 9-4. 동작 확인

1. **클라이언트** 로그인 → **부가 서비스 스토어**(사이드바 또는 개요 하단) → 아무 서비스 **신청하기** → 메모 입력 후 접수
2. **관리자** → **부가서비스 주문** 메뉴에서 해당 주문 행 확인 (상태 변경·관리자 메모 저장 가능)
3. **관리자 휴대폰**에 알림톡 수신 여부 확인 (`ADMIN_NOTIFY_PHONE` 설정 시)

- [ ] 클라이언트에서 부가 서비스 1건 신청 성공
- [ ] 관리자 화면에서 주문 목록·상태/메모 수정 확인
- [ ] (선택) 관리자 번호로 주문 접수 알림톡 수신 확인

---

## 10. 숙제 체크리스트 요약

| # | 할 일 | 완료 |
|---|--------|------|
| 1 | `.env.local`에 SOLAPI 4종 + 배포 시 Vercel 환경 변수 | [ ] |
| 2 | 솔라피 가입 및 API Key·Secret 발급 | [ ] |
| 3 | 카카오 비즈니스 채널 생성 + 솔라피 연동 + PFID 설정 | [ ] |
| 4 | 알림톡 템플릿 7종(기존 4 + 월/수/목 3) 카카오에 등록·승인 | [ ] |
| 5 | Vercel에 CRON_SECRET, NEXT_PUBLIC_APP_URL(실서비스), SOLAPI_* 설정 | [ ] |
| 6 | 관리자 알림 설정에서 테스트 발송 1회 성공 | [ ] |
| 7 | (선택) Cron 수동 호출 또는 실제 요일 발송 확인 | [ ] |
| **8** | **Migration 009 실행 (addon_orders 테이블)** | [x] |
| **9** | **ADMIN_NOTIFY_PHONE 설정 + (배포 시) Vercel 환경 변수** | [ ] |
| **10** | **TPL_addon_order_admin 템플릿 카카오 등록·승인** | [ ] |
| **11** | **부가 서비스 신청 → 관리자 목록·알림톡 동작 확인** | [ ] |

SQL 007·008·009는 완료한 상태이므로, 위만 차례대로 하면 월/수/목 알림톡 + 매직링크 + **부가 서비스 스토어(주문·관리자 알림)**까지 사용할 수 있습니다.
