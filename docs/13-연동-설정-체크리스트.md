# 연동 설정 체크리스트 (네이버 / Meta / GA4 / Google Ads)

> 관리자 **데이터 연동** 탭의 선택지 4개가 **모두 코드에 연결**돼 있습니다. 아래대로 env·입력값만 넣으면 테스트 가능합니다.

---

## 🔑 원케이션(관리자) 1세트 vs 클라이언트마다 — 계속 발급해야 하나요?

**아니요. 원케이션이 한 번만 발급·설정해 두면 됩니다.**  
클라이언트(연동)별로 받는 토큰은 **연동 추가할 때 1번만** 받아서 DB에 저장해 두고, 그걸로 계속 씁니다.

| 구분 | 누가·몇 번? | 재발급? |
|------|-------------|--------|
| **원케이션 1세트 (한 번만)** | **관리자(원케이션)**가 Meta 앱 1개, Google OAuth 클라이언트 1개 만듦 → `.env.local`에 **한 번** 넣음 | ❌ 안 함. App ID/Secret, Client ID/Secret은 계속 씀 |
| **Access Token / Refresh Token** | **각 클라이언트**가 데이터 연동 탭에서 "Meta OAuth" 또는 "Google OAuth" 버튼으로 **한 번** 로그인·동의 | ❌ 한 번 받으면 DB에 저장해 두고 계속 씀. (Meta long-lived는 약 60일이어서 만료 전에 다시 OAuth 하면 됨) |
| **API Key / Secret (네이버)** | **각 클라이언트(광고주)**가 네이버 검색광고에서 API 라이선스 1개 발급 → 관리자가 그 클라이언트 연동에 **한 번** 입력 | ❌ 한 번 넣으면 저장해 두고 계속 씀 |
| **Developer Token (Google Ads)** | 원케이션이 Google Ads API 센터에서 **1개** 발급해 쓰는 경우가 많음 → 아래처럼 env로 두면 연동마다 입력 안 해도 됨 | ❌ 한 번 넣으면 됨 |

**정리**

- **.env.local (원케이션 1세트)**: `META_APP_ID`, `META_APP_SECRET`, `GOOGLE_CLIENT_ID`, `GOOGLE_CLIENT_SECRET`, `NEXT_PUBLIC_APP_URL` → **한 번 설정 후 재발급 없음.**
- **연동마다 저장되는 값**: 그 **클라이언트**가 OAuth 한 번 하면 받은 Access Token / Refresh Token + 광고 계정 ID·Customer ID 등 → **연동 추가 시 1번만** 받아서 DB에 저장, 이후 재발급 없이 사용 (Meta는 만료 시 해당 연동만 다시 OAuth).

---

## ✅ 연동 상태 요약

| 플랫폼 | 선택자 | 연동 여부 | 연결 테스트 | 수동 동기화 |
|--------|--------|-----------|-------------|-------------|
| 네이버 검색광고 | 네이버 검색광고 | ✅ 연동됨 | ✅ | ✅ |
| Meta 광고 | Meta 광고 (Facebook/Instagram) | ✅ 연동됨 | ✅ | ✅ |
| Google Ads | Google Ads | ✅ 연동됨 | ✅ | ✅ |
| GA4 | Google Analytics (GA4) | ✅ 연동됨 | ✅ | ✅ |

- **연동 추가** 다이얼로그: 플랫폼 선택 → 해당 필드 입력 → **연결 테스트** → **연동 저장**
- 저장된 연동 카드에서 **🔄 수동 동기화**로 값 받아오기

---

## 1. 환경 변수 (.env.local)

| 변수 | 용도 | 네이버 | Meta | Google Ads | GA4 |
|------|------|--------|------|------------|-----|
| `NEXT_PUBLIC_APP_URL` | OAuth 콜백 URL 기준 | - | ✅ | ✅ | ✅ |
| `META_APP_ID` | Meta OAuth / 토큰 교환 | - | ✅ | - | - |
| `META_APP_SECRET` | Meta OAuth / 토큰 교환 | - | ✅ | - | - |
| `GOOGLE_CLIENT_ID` | Google OAuth / 토큰 갱신 | - | - | ✅ | ✅ |
| `GOOGLE_CLIENT_SECRET` | Google OAuth / 토큰 갱신 | - | - | ✅ | ✅ |
| `GOOGLE_DEVELOPER_TOKEN` | Google Ads API (선택) | - | - | ✅ | - |

- **네이버**: env 없이 **API Key, Secret Key, Customer ID**만 입력하면 됨.
- **Meta**: OAuth 버튼 쓸 때만 `META_APP_ID`, `META_APP_SECRET` 필요. 수동으로 Access Token 넣을 때는 불필요.
- **Google Ads / GA4**: Refresh Token 쓰려면 서버에서 access_token 갱신할 때 `GOOGLE_CLIENT_ID`, `GOOGLE_CLIENT_SECRET`, `NEXT_PUBLIC_APP_URL` 필요.
- **Google Ads**: `.env`에 `GOOGLE_DEVELOPER_TOKEN` 넣어 두면 연동마다 Developer Token 입력 안 해도 됨 (원케이션 1개로 통일).
- **관리자 페이지에서 키값 관리**: 관리자 → 클라이언트 → (아무 클라이언트) → **데이터 연동** 탭 → **연동 기본 설정** 버튼에서 META_APP_ID, GOOGLE_CLIENT_ID 등 한 번만 저장해 두면, OAuth 시 **프롬프트 없이** 바로 인증됩니다. (DB에 저장되며, .env보다 우선)

---

## 2. 플랫폼별 입력값 (관리자 UI에서 넣을 것)

### 네이버 검색광고

| 필드 | 설명 | 예시 |
|------|------|------|
| 표시 이름 | 연동 목록에 보일 이름 | 네이버 키워드 광고 |
| API Key | 네이버 검색광고 API Key | (발급값) |
| Secret Key | 네이버 검색광고 Secret Key | (발급값) |
| Customer ID | 네이버 검색광고 Customer ID | (발급값) |

- 발급: [네이버 검색광고 API 관리](https://manage.searchad.naver.com) → API 관리 → 라이선스 발급

---

### Meta 광고 (Facebook/Instagram)

| 필드 | 설명 | 예시 |
|------|------|------|
| 표시 이름 | 연동 목록에 보일 이름 | Meta 광고 |
| Access Token | (선택) OAuth 대신 직접 입력 시 | - |
| Ad Account ID | 광고 계정 ID | `act_123456789` |

- **권장:** 상단 **Meta OAuth** 버튼 → Facebook 인증 → 돌아온 뒤 광고 계정 ID만 입력 후 저장 (토큰은 자동).
- **직접 입력:** 연동 추가 → Meta 광고 선택 → Access Token + Ad Account ID 입력.

---

### Google Ads

| 필드 | 설명 | 예시 |
|------|------|------|
| 표시 이름 | 연동 목록에 보일 이름 | Google Ads 메인 |
| Refresh Token | Google OAuth로 발급한 refresh_token | (OAuth 후 URL 또는 수동 발급) |
| Customer ID | Google Ads 고객 ID (숫자만 또는 123-456-7890) | `1234567890` 또는 `123-456-7890` |
| Developer Token | Google Ads API Developer Token | (ads.google.com → API 센터에서 발급) |

- **Refresh Token:** 상단 **Google OAuth** 버튼으로 인증 후 돌아오면 URL에 `googleRefreshToken=...` 붙어 있음. 복사해서 여기 붙여넣기.
- **Developer Token:** [Google Ads](https://ads.google.com) → 도구 및 설정 → 설정 → API 센터.

---

### Google Analytics (GA4)

| 필드 | 설명 | 예시 |
|------|------|------|
| 표시 이름 | 연동 목록에 보일 이름 | GA4 메인 |
| Refresh Token | Google OAuth refresh_token (Ads와 동일 사용 가능) | (Google OAuth 후 URL에서 복사) |
| Property ID | GA4 속성 ID | `properties/123456789` |

- **Property ID:** GA4 관리 → 속성 → 속성 설정 → **속성 ID** (숫자만 있으면 앞에 `properties/` 붙여서 입력).

---

## 3. 테스트 순서 (값 넣어서 확인)

1. **관리자 로그인** → **클라이언트** → 테스트할 클라이언트(예: 성신컴퍼니) → **데이터 연동** 탭
2. **연동 추가** 클릭
3. **플랫폼** 선택 (네이버 / Meta 광고 / Google Ads / GA4)
4. **표시 이름** + 해당 플랫폼 필드에 값 입력
5. **연결 테스트** 클릭 → "✅ 연결 성공!" 확인
6. **연동 저장** 클릭
7. 목록에 연동 카드가 생기면 **🔄 수동 동기화** 클릭
8. 동기화 완료 후 Supabase **Table Editor** → `platform_metrics` 에서 해당 `client_id`·`platform` 데이터 확인

---

## 4. 코드 연결 위치 (참고)

| 역할 | 파일 |
|------|------|
| 선택자·폼·수동 동기화 버튼 | `src/app/admin/clients/[id]/client-detail.tsx` (IntegrationTab) |
| 연동 CRUD·동기화 API | `src/app/api/admin/integrations/route.ts`, `sync/route.ts`, `test/route.ts` |
| 플랫폼별 fetch·테스트 | `src/lib/integrations/naver.ts`, `meta.ts`, `google-ads.ts`, `ga4.ts` |
| 동기화 엔진 (플랫폼 → platform_metrics) | `src/lib/integrations/sync-engine.ts` |

---

*env 확인 후 위 입력값만 넣고 **연결 테스트** → **연동 저장** → **수동 동기화** 순서로 테스트하시면 됩니다.*
